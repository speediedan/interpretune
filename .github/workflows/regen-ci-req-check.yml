name: regen-ci-req-check (scheduled)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 1,15 * *'  # run 00:00 UTC on 1st and 15th of each month

jobs:
  regen:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install regen deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install pip-tools toml

      - name: Run regen (pip-compile)
        run: |
          python requirements/regen_reqfiles.py --mode pip-compile --ci-output-dir=requirements/ci

      - name: Check for diffs
        id: diffs
        run: |
          set -euo pipefail
          changed=false
          # portable git diff invocation (do not use --no-color)
          git --no-pager diff --quiet --exit-code requirements/ci/requirements.txt requirements/post_upgrades.txt requirements/platform_dependent.txt || changed=true
          echo "changed=$changed" >> $GITHUB_OUTPUT

      - name: Create PR with updated pins
        if: steps.diffs.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "[auto] regen pinned requirements"
          commit-message: "Auto-regenerate pinned requirements via scheduled regen-check"
          branch: regen/pinned-requirements-${{ github.run_id }}
          body: |
            This PR was opened by the scheduled regen-check workflow. It contains regenerated pinned requirement files.
            Please review tests and CI results before merging.
          labels: automated, dependencies

      - name: Report no changes
        if: ${{ steps.diffs.outputs.changed == 'false' }}
        run: |
          echo "No pin file changes detected by regen-check."
