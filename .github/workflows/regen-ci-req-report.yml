name: regen-ci-req-report (report-only)

on:
  workflow_dispatch:
  push:
    branches: [main, "release/*", "bugfix/*", "feature/*"]
    paths:
      - "setup.*"
      - "requirements.txt"
      - "pyproject.toml"
      - ".codecov.yml"
      - "tests/**"
      - "src/**"
      - "requirements/**"
      - ".github/workflows/ci_test-full.yml"
      - ".actions/**"
      # Exclude documentation-only files from triggering
      - "!docs/**"
      - "!**/*.md"
      - "!**/*.rst"
      - "!mkdocs.yml"
      - "!**/CHANGELOG.md"
      - "!**/CODE_OF_CONDUCT.md"
      - "!**/CONTRIBUTING.md"
      - "!**/LICENSE*"
  pull_request:
    branches: [main, "release/*", "bugfix/*", "feature/*"]
    types: [opened, reopened, ready_for_review, synchronize]
    paths:
      - "setup.*"
      - "requirements.txt"
      - "pyproject.toml"
      - ".codecov.yml"
      - "tests/**"
      - "src/**"
      - "requirements/**"
      - ".github/workflows/ci_test-full.yml"
      - ".actions/**"
      # Exclude documentation-only files from triggering
      - "!docs/**"
      - "!**/*.md"
      - "!**/*.rst"
      - "!mkdocs.yml"
      - "!**/CHANGELOG.md"
      - "!**/CODE_OF_CONDUCT.md"
      - "!**/CONTRIBUTING.md"
      - "!**/LICENSE*"

jobs:
  report:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install regen deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install pip-tools toml

      - name: Run regen (pip-compile)
        run: |
          # Run regen to generate the CI input and post-upgrade files
          python requirements/regen_reqfiles.py --mode pip-compile --ci-output-dir=requirements/ci

      - name: Check for diffs and write patch
        id: diffs
        run: |
          set -euo pipefail
          # create a patch into a file if anything differs; do not treat 'diff' non-zero as an error
          git --no-pager diff --exit-code requirements/ci/requirements.txt requirements/post_upgrades.txt requirements/platform_dependent.txt > regen_diff.patch || true
          if [ -s regen_diff.patch ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Patch size: $(wc -c < regen_diff.patch) bytes"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes"
          fi

      - name: Upload regen diff (if present)
        if: steps.diffs.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: regen-pins-diff
          path: regen_diff.patch
      - name: Compute top-5 package-change summary
        if: steps.diffs.outputs.changed == 'true'
        run: |
          python - <<'PY'
          import re
          from pathlib import Path
          patch = Path('regen_diff.patch')
          out = Path('regen_summary.txt')
          if not patch.exists() or patch.stat().st_size == 0:
              out.write_text('')
              print('No patch to summarize')
              raise SystemExit(0)

          def parse_req(line):
              # strip leading +/- and whitespace
              s = line[1:].strip()
              # remove inline comments
              s = re.sub(r"\s+#.*$", "", s).strip()
              # If it's a VCS or URL spec, return the whole spec as the name for now
              if s.startswith('git+') or s.startswith('http://') or s.startswith('https://') or 'egg=' in s:
              # try to extract egg name
              m = re.search(r'egg=([^&\n]+)', s)
              if m:
                  return m.group(1), s
              return s, s
              # Match name[extras] optional comparator
              m = re.match(r"^([A-Za-z0-9._+\-]+)(?:\[[^\]]+\])?\s*(?:([<>!=~]{1,2})\s*(\S+))?", s)
              if m:
              name = m.group(1)
              op = m.group(2) or ''
              ver = m.group(3) or ''
              spec = (op + ver).strip()
              return name, spec
              return s, ''

          added = {}
          removed = {}
          for ln in patch.read_text().splitlines():
              if not ln:
              continue
              if ln.startswith(('+++', '---', 'diff ', 'index ', '@@')):
              continue
              if ln.startswith('+'):
              name, spec = parse_req(ln)
              added[name] = spec
              elif ln.startswith('-'):
              name, spec = parse_req(ln)
              removed[name] = spec

          keys = sorted(set(list(added.keys()) + list(removed.keys())))
          changes = []
          for k in keys:
              a = added.get(k)
              r = removed.get(k)
              if r and a:
              changes.append(f"{k}: {r or '<unspecified>'} â†’ {a or '<unspecified>'}")
              elif a and not r:
              changes.append(f"{k}: added {a or ''}")
              elif r and not a:
              changes.append(f"{k}: removed {r or ''}")

          if changes:
              keep = changes[:5]
              content = 'Top changes:\n' + '\n'.join(f"{i+1}. {s}" for i,s in enumerate(keep))
              out.write_text(content)
              print(content)
          else:
              out.write_text('')
              print('No package-like changes found in patch')
          PY


      - name: Create or update PR comment (single-comment)
        if: ${{ github.event_name == 'pull_request' && steps.diffs.outputs.changed == 'true' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const marker = '<!-- regen-check-pins -->';
            let summary = '';
            try {
              const fs = require('fs');
              const sumPath = 'regen_summary.txt';
              if (fs.existsSync(sumPath)) {
                summary = fs.readFileSync(sumPath, 'utf8').trim();
              }
            } catch (e) {
              console.warn('Failed to read regen_summary.txt for summary:', e && e.message ? e.message : String(e));
            }
            const bodyText = `${marker}\n**regen-check** detected changes to pinned requirements and uploaded a patch artifact named 'regen-pins-diff'.\n\n${summary ? summary + '\n\n' : ''}Please review the artifact and CI results. This workflow is report-only and will not open a PR; the scheduled regen workflow will open PRs automatically.`;
            const pr = context.payload.pull_request && context.payload.pull_request.number;
            const headFullName = context.payload.pull_request && context.payload.pull_request.head && context.payload.pull_request.head.repo && context.payload.pull_request.head.repo.full_name;
            const baseFullName = context.payload.repository && context.payload.repository.full_name;
            if (!pr) {
              console.log('No pull_request payload found; skipping comment.');
              return;
            }
            console.log(`PR head repo: ${headFullName}; base repo from payload: ${baseFullName}`);
            if (!baseFullName) {
              console.log('Base repository not found in payload; skipping comment to be safe.');
              return;
            }
            if (headFullName !== baseFullName) {
              console.log(`PR head repo (${headFullName}) differs from base repo (${baseFullName}); skipping comment to avoid permission errors.`);
              return;
            }
            try {
              // list comments and try to find an existing one with the marker (use github.rest)
              const { data: comments } = await github.rest.issues.listComments({ owner: context.repo.owner, repo: context.repo.repo, issue_number: pr });
              const existing = comments.find(c => c.body && c.body.includes(marker));
              if (existing) {
                await github.rest.issues.updateComment({ owner: context.repo.owner, repo: context.repo.repo, comment_id: existing.id, body: bodyText });
              } else {
                await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: pr, body: bodyText });
              }
            } catch (err) {
              // If commenting fails (e.g., fork PRs or limited permissions), log the error but don't fail the workflow
              console.warn(`Failed to create/update PR comment: ${err && err.message ? err.message : String(err)}`);
              console.log(err);
            }

      - name: Log summary
        run: |
          if [ "${{ steps.diffs.outputs.changed }}" = "true" ]; then
            echo "Regen-check detected changes to pinned requirements. A patch artifact was uploaded as 'regen-pins-diff'."
            echo "This workflow is report-only and will not open a PR; the scheduled regen workflow will open PRs automatically."
          else
            echo "Regen-check found no pin changes."
          fi
