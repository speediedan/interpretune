name: Regen CI reqs runner
description: Install regen deps, run regen (pip-compile), and produce a patch if pins differ. Also performs checkout and Python setup.
inputs:
  python_version:
    description: 'Python version to setup'
    required: false
    default: '3.12'
  ci_output_dir:
    description: Directory where regen writes CI output (defaults to requirements/ci)
    required: false
    default: requirements/ci
  compare_paths:
    description: Space-separated list of files/paths to compare with git diff
    required: false
    default: "requirements/ci/requirements.txt"
  patch_path:
    description: Path to write the patch file
    required: false
    default: regen_diff.patch
runs:
  using: composite
  steps:
    - name: Install uv
      shell: bash
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Run lock regeneration
      shell: bash
      run: |
        bash requirements/utils/lock_ci_requirements.sh

    - id: check
      name: Check for diffs and write patch
      uses: ./.github/actions/check-file-diffs
      with:
        compare_paths: ${{ inputs.compare_paths }}
        patch_path: ${{ inputs.patch_path }}
        error_message: "CI requirements have changed and need to be regenerated"

outputs:
  changed:
    description: 'true if files differ'
    value: ${{ steps.check.outputs.changed }}
  patch_path:
    description: 'path to generated patch file'
    value: ${{ steps.check.outputs.patch_path }}
